cmake_minimum_required(VERSION 3.20)
project(LupineEngine VERSION 1.0.0 LANGUAGES CXX)

#--- Load Platform Configuration ---
# Include platform-specific configuration generated by setup script
set(PLATFORM_CONFIG_FILE "${CMAKE_CURRENT_SOURCE_DIR}/cmake/PlatformConfig.cmake")
if(EXISTS "${PLATFORM_CONFIG_FILE}")
  # Check if the platform config matches current system
  if(WIN32)
    set(EXPECTED_PLATFORM "WINDOWS")
  elseif(APPLE)
    set(EXPECTED_PLATFORM "MACOS")
  elseif(UNIX)
    set(EXPECTED_PLATFORM "LINUX")
  endif()

  # Read the platform config to check if it matches
  file(READ "${PLATFORM_CONFIG_FILE}" PLATFORM_CONFIG_CONTENT)
  if(PLATFORM_CONFIG_CONTENT MATCHES "set\\(LUPINE_PLATFORM \"${EXPECTED_PLATFORM}\"\\)")
    include("${PLATFORM_CONFIG_FILE}")
    message(STATUS "Loaded platform configuration: ${PLATFORM_CONFIG_FILE}")
  else()
    message(WARNING "Platform configuration exists but is for wrong platform. Skipping.")
  endif()
else()
  message(WARNING "Platform configuration not found. Using default configuration.")
endif()

#--- C++ Standard & Build Type ---
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
if(NOT CMAKE_BUILD_TYPE)
  set(CMAKE_BUILD_TYPE Release CACHE STRING "Build type" FORCE)
endif()

#--- Enhanced Platform Detection ---
if(WIN32)
  set(PLATFORM_NAME "Windows")
  set(PLATFORM_TRIPLET "x64-windows-static")
elseif(APPLE)
  if(CMAKE_OSX_ARCHITECTURES MATCHES "arm64" OR CMAKE_SYSTEM_PROCESSOR MATCHES "arm64")
    set(PLATFORM_NAME "Mac-ARM64")
    set(PLATFORM_TRIPLET "arm64-osx")
  else()
    set(PLATFORM_NAME "Mac-OSX")
    set(PLATFORM_TRIPLET "x64-osx")
  endif()
elseif(UNIX)
  set(PLATFORM_NAME "Linux")
  set(PLATFORM_TRIPLET "x64-linux")
else()
  message(FATAL_ERROR "Unsupported platform")
endif()

#--- Compiler Flags ---
if(MSVC)
  set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")
  add_compile_options(/Zc:__cplusplus /permissive- /W4)
  # Enable parallel compilation
  add_compile_options(/MP)
else()
  add_compile_options(-Wall -Wextra -Wpedantic)
  set(CMAKE_POSITION_INDEPENDENT_CODE ON)
  # Enable parallel compilation for GCC/Clang
  include(ProcessorCount)
  ProcessorCount(N)
  if(NOT N EQUAL 0)
    set(CMAKE_BUILD_PARALLEL_LEVEL ${N})
  endif()
endif()

#--- Static Linking Configuration ---
set(BUILD_SHARED_LIBS OFF)
if(WIN32)
  set(CMAKE_FIND_LIBRARY_SUFFIXES .lib .a)
else()
  set(CMAKE_FIND_LIBRARY_SUFFIXES .a .so)
endif()

#--- Third-Party Directories ---
set(THIRDPARTY_DIR "${CMAKE_CURRENT_SOURCE_DIR}/thirdparty")
set(EMSDK_DIR       "${THIRDPARTY_DIR}/emsdk")
set(QT_DIR          "${THIRDPARTY_DIR}/Qt")
set(PLATFORM_DIR    "${THIRDPARTY_DIR}/${PLATFORM_NAME}")

# Options for build configuration
option(LUPINE_ENABLE_EDITOR "Build the Qt-based editor" ON)
option(LUPINE_ENABLE_EXPORT "Enable cross-platform export functionality" ON)
option(LUPINE_ENABLE_RUNTIME_ONLY "Build only runtime (no editor dependencies)" OFF)

# Cross-compilation is always enabled
set(LUPINE_ENABLE_CROSS_COMPILATION ON CACHE BOOL "Enable cross-platform compilation" FORCE)

# Override editor option if runtime-only is requested
if(LUPINE_ENABLE_RUNTIME_ONLY)
  set(LUPINE_ENABLE_EDITOR OFF)
endif()

#--- vcpkg Integration ---
if(WIN32)
  set(VCPKG_DIR "${THIRDPARTY_DIR}/vcpkg")
  if(EXISTS "${VCPKG_DIR}/scripts/buildsystems/vcpkg.cmake")
    set(CMAKE_TOOLCHAIN_FILE "${VCPKG_DIR}/scripts/buildsystems/vcpkg.cmake" CACHE STRING "")
    set(VCPKG_TARGET_TRIPLET "${PLATFORM_TRIPLET}" CACHE STRING "")
    message(STATUS "Using vcpkg toolchain: ${CMAKE_TOOLCHAIN_FILE}")
  endif()
endif()

#--- Qt Configuration ---
if(LUPINE_ENABLE_EDITOR)
  # Platform-specific Qt paths
  if(WIN32)
    set(QT_STATIC_DIR "${PLATFORM_DIR}/qtbase_x64-windows-static")
    if(EXISTS "${QT_STATIC_DIR}")
      set(Qt6_DIR "${QT_STATIC_DIR}/share/Qt6")
      set(QT_HOST_PATH "${QT_DIR}")
      set(QT_HOST_PATH_CMAKE_DIR "${QT_DIR}/share" CACHE PATH "Host Qt CMake directory")
      add_compile_definitions(QT_STATIC_BUILD)
    else()
      # Fallback to vcpkg Qt
      set(Qt6_DIR "${VCPKG_DIR}/installed/${PLATFORM_TRIPLET}/share/Qt6")
    endif()
  elseif(APPLE)
    # Use Homebrew Qt
    if(CMAKE_OSX_ARCHITECTURES MATCHES "arm64")
      set(HOMEBREW_PREFIX "/opt/homebrew")
    else()
      set(HOMEBREW_PREFIX "/usr/local")
    endif()
    set(Qt6_DIR "${HOMEBREW_PREFIX}/opt/qt6/lib/cmake/Qt6")
    set(QT_HOST_PATH "${HOMEBREW_PREFIX}/opt/qt6")
  else()
    # Linux system Qt
    find_program(QMAKE_EXECUTABLE NAMES qmake6 qmake)
    if(QMAKE_EXECUTABLE)
      execute_process(COMMAND ${QMAKE_EXECUTABLE} -query QT_INSTALL_PREFIX
                      OUTPUT_VARIABLE QT_INSTALL_PREFIX
                      OUTPUT_STRIP_TRAILING_WHITESPACE)
      set(Qt6_DIR "${QT_INSTALL_PREFIX}/lib/cmake/Qt6")
      set(QT_HOST_PATH "${QT_INSTALL_PREFIX}")
    endif()
  endif()
endif()

#--- Library Search Paths ---
list(APPEND CMAKE_PREFIX_PATH
  ${EMSDK_DIR}
  ${QT_DIR}
  ${PLATFORM_DIR}
)

if(WIN32 AND EXISTS "${QT_STATIC_DIR}")
  list(APPEND CMAKE_PREFIX_PATH ${QT_STATIC_DIR})
endif()

# Add all platform-specific package directories efficiently
if(EXISTS "${PLATFORM_DIR}")
  file(GLOB PLATFORM_PACKAGES "${PLATFORM_DIR}/*")
  foreach(package IN LISTS PLATFORM_PACKAGES)
    if(IS_DIRECTORY "${package}")
      list(APPEND CMAKE_PREFIX_PATH "${package}")
      # Add lib and include directories if they exist
      if(EXISTS "${package}/lib")
        link_directories("${package}/lib")
      endif()
      if(EXISTS "${package}/include")
        include_directories("${package}/include")
      endif()
    endif()
  endforeach()
endif()

#--- Emscripten Support ---
option(BUILD_WEB_TEMPLATE "Build web export template" OFF)
if(BUILD_WEB_TEMPLATE)
  find_program(EMCC_EXECUTABLE emcc HINTS "${EMSDK_DIR}/bin" REQUIRED)
  set(CMAKE_C_COMPILER   ${EMCC_EXECUTABLE})
  set(CMAKE_CXX_COMPILER ${EMCC_EXECUTABLE})
  message(STATUS "Using Emscripten: ${EMCC_EXECUTABLE}")
endif()

#--- Debug Information ---
message(STATUS "=== Lupine Engine Build Configuration ===")
message(STATUS "Platform: ${PLATFORM_NAME}")
message(STATUS "Triplet: ${PLATFORM_TRIPLET}")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "Editor Enabled: ${LUPINE_ENABLE_EDITOR}")
message(STATUS "Export Enabled: ${LUPINE_ENABLE_EXPORT}")
message(STATUS "Platform Directory: ${PLATFORM_DIR}")
message(STATUS "Third-party Directory: ${THIRDPARTY_DIR}")

#--- Qt Setup (if enabled) ---
if(LUPINE_ENABLE_EDITOR)
  message(STATUS "=== Qt Configuration ===")

  # Simplified Qt configuration to avoid hanging
  set(CMAKE_FIND_PACKAGE_PREFER_CONFIG ON)

  # Skip problematic system dependencies that cause hangs
  set(CMAKE_DISABLE_FIND_PACKAGE_WrapSystemDoubleConversion ON)
  set(CMAKE_DISABLE_FIND_PACKAGE_WrapSystemHarfbuzz ON)
  set(CMAKE_DISABLE_FIND_PACKAGE_WrapSystemFreetype ON)
  set(CMAKE_DISABLE_FIND_PACKAGE_WrapSystemPCRE2 ON)
  set(CMAKE_DISABLE_FIND_PACKAGE_WrapSystemZLIB ON)

  # Try to find Qt6 with minimal configuration
  message(STATUS "Searching for Qt6 (simplified configuration)...")

  find_package(Qt6 QUIET COMPONENTS Core Widgets Gui)

  if(Qt6_FOUND)
    message(STATUS "✅ Qt6 found successfully")

    # Try to find optional OpenGL components
    find_package(Qt6OpenGL QUIET)
    find_package(Qt6OpenGLWidgets QUIET)

    # Find Qt tools
    find_program(Qt6_MOC_EXECUTABLE NAMES moc moc.exe)
    find_program(Qt6_UIC_EXECUTABLE NAMES uic uic.exe)
    find_program(Qt6_RCC_EXECUTABLE NAMES rcc rcc.exe)

    if(Qt6_MOC_EXECUTABLE AND Qt6_UIC_EXECUTABLE AND Qt6_RCC_EXECUTABLE)
      message(STATUS "✅ Qt6 tools found")
    else()
      message(WARNING "⚠️  Some Qt6 tools missing, but continuing...")
    endif()

  else()
    message(WARNING "❌ Qt6 not found. Disabling editor build.")
    set(LUPINE_ENABLE_EDITOR OFF)
  endif()
else()
  message(STATUS "Qt editor disabled - building runtime only")
endif()

#--- Include Directories ---
set(ENGINE_INCLUDE_DIRS
  "${CMAKE_CURRENT_SOURCE_DIR}/include"
)

# Add Emscripten includes if available
if(EXISTS "${EMSDK_DIR}/include")
  list(APPEND ENGINE_INCLUDE_DIRS "${EMSDK_DIR}/include")
endif()

# Add Qt includes if editor is enabled
if(LUPINE_ENABLE_EDITOR AND EXISTS "${QT_DIR}/include")
  list(APPEND ENGINE_INCLUDE_DIRS "${QT_DIR}/include")
endif()

# Add platform-specific includes from packages
if(EXISTS "${PLATFORM_DIR}")
  file(GLOB PLATFORM_PACKAGES "${PLATFORM_DIR}/*")
  foreach(package IN LISTS PLATFORM_PACKAGES)
    if(IS_DIRECTORY "${package}")
      if(EXISTS "${package}/include")
        list(APPEND ENGINE_INCLUDE_DIRS "${package}/include")

        # Add SDL2 specific includes
        if(EXISTS "${package}/include/SDL2")
          list(APPEND ENGINE_INCLUDE_DIRS "${package}/include/SDL2")
        endif()

        # Add Python specific includes
        file(GLOB PYTHON_INCLUDES "${package}/include/python*")
        foreach(python_inc IN LISTS PYTHON_INCLUDES)
          if(IS_DIRECTORY "${python_inc}")
            list(APPEND ENGINE_INCLUDE_DIRS "${python_inc}")
          endif()
        endforeach()
      endif()
    endif()
  endforeach()
endif()

# Add common third-party includes
set(COMMON_INCLUDES
  "${THIRDPARTY_DIR}/glad/include"
  "${THIRDPARTY_DIR}/stb"
  "${THIRDPARTY_DIR}/box2d/include"
)

foreach(inc_dir IN LISTS COMMON_INCLUDES)
  if(EXISTS "${inc_dir}")
    list(APPEND ENGINE_INCLUDE_DIRS "${inc_dir}")
  endif()
endforeach()

# Set global include directories
include_directories(${ENGINE_INCLUDE_DIRS})

message(STATUS "Include directories configured:")
foreach(inc_dir IN LISTS ENGINE_INCLUDE_DIRS)
  message(STATUS "  ${inc_dir}")
endforeach()

#--- Engine Sources & Headers ---
file(GLOB_RECURSE ENGINE_SOURCES
  "src/animation/*.cpp"
  "src/audio/*.cpp"
  "src/components/*.cpp"
  "src/core/*.cpp"
  "src/export/*.cpp"
  "src/input/*.cpp"
  "src/localization/*.cpp"
  "src/nodes/*.cpp"
  "src/physics/*.cpp"
  "src/rendering/*.cpp"
  "src/resources/*.cpp"
  "src/scriptableobjects/*.cpp"
  "src/scripting/*.cpp"
  "src/serialization/*.cpp"
  "src/terrain/*.cpp"
  "src/tilemap/*.cpp"
  "src/visualscripting/*.cpp"
)

# Add GLAD source - check if we need to compile it or if it's already a library
set(GLAD_SOURCE_ADDED FALSE)
if(WIN32 AND EXISTS "${PLATFORM_DIR}/glad_x64-windows-static/lib/glad.lib")
  # Use precompiled GLAD library on Windows
  set(GLAD_LIBRARY "${PLATFORM_DIR}/glad_x64-windows-static/lib/glad.lib")
  set(GLAD_SOURCE_ADDED TRUE)
elseif(EXISTS "${THIRDPARTY_DIR}/glad/src/glad.c")
  # Use source file if available
  list(APPEND ENGINE_SOURCES "${THIRDPARTY_DIR}/glad/src/glad.c")
  set(GLAD_SOURCE_ADDED TRUE)
endif()

if(NOT GLAD_SOURCE_ADDED)
  message(WARNING "GLAD source or library not found. OpenGL loading may not work.")
endif()

file(GLOB_RECURSE ENGINE_HEADERS
  "include/lupine/*.h"
  "src/*/*.h"
)

#--- Engine Library ---
add_library(LupineEngine STATIC ${ENGINE_SOURCES} ${ENGINE_HEADERS})

#--- Find Required Libraries ---
message(STATUS "=== Library Configuration ===")

# Add our custom CMake modules to the path
list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/cmake")

# Use our custom dependency finder
find_package(LupineDependencies REQUIRED)

# Add GLAD source or library
set(GLAD_SOURCE_ADDED FALSE)
if(WIN32 AND EXISTS "${PLATFORM_DIR}/glad_x64-windows-static/lib/glad.lib")
  list(APPEND LupineDependencies_LIBRARIES "${PLATFORM_DIR}/glad_x64-windows-static/lib/glad.lib")
  set(GLAD_SOURCE_ADDED TRUE)
elseif(EXISTS "${THIRDPARTY_DIR}/glad/src/glad.c")
  # GLAD source will be added to ENGINE_SOURCES
  set(GLAD_SOURCE_ADDED TRUE)
endif()

if(NOT GLAD_SOURCE_ADDED)
  message(WARNING "GLAD source or library not found. OpenGL loading may not work.")
endif()

# Use the collected libraries
set(ENGINE_LIBRARIES ${LupineDependencies_LIBRARIES})

list(LENGTH ENGINE_LIBRARIES lib_count)
message(STATUS "Found ${lib_count} engine libraries")

#--- Link Engine Dependencies ---
target_link_libraries(LupineEngine PRIVATE ${ENGINE_LIBRARIES})

# Add Qt libraries if editor is enabled
if(LUPINE_ENABLE_EDITOR AND Qt6_FOUND)
  target_link_libraries(LupineEngine PRIVATE
    Qt6::Core Qt6::Widgets Qt6::Gui Qt6::OpenGL Qt6::OpenGLWidgets
  )

  # For static Qt builds on Windows
  if(WIN32 AND QT_STATIC_DIR)
    if(TARGET Qt6::EntryPoint)
      target_link_libraries(LupineEngine PRIVATE Qt6::EntryPoint)
    endif()

    # Windows system libraries for static Qt
    target_link_libraries(LupineEngine PRIVATE
      dwmapi uxtheme winmm imm32 wtsapi32 setupapi version
      netapi32 userenv crypt32 secur32 bcrypt
    )
  endif()
endif()

#--- Platform System Libraries ---
if(WIN32)
  target_link_libraries(LupineEngine PRIVATE
    user32 gdi32 shell32 advapi32 kernel32 ws2_32 opengl32
  )
elseif(APPLE)
  # macOS frameworks
  find_library(COCOA_FRAMEWORK Cocoa REQUIRED)
  find_library(IOKIT_FRAMEWORK IOKit REQUIRED)
  find_library(OPENGL_FRAMEWORK OpenGL REQUIRED)
  find_library(COREAUDIO_FRAMEWORK CoreAudio REQUIRED)
  find_library(AUDIOTOOLBOX_FRAMEWORK AudioToolbox REQUIRED)

  target_link_libraries(LupineEngine PRIVATE
    ${COCOA_FRAMEWORK} ${IOKIT_FRAMEWORK} ${OPENGL_FRAMEWORK}
    ${COREAUDIO_FRAMEWORK} ${AUDIOTOOLBOX_FRAMEWORK}
  )
elseif(UNIX)
  # Linux system libraries
  find_package(Threads REQUIRED)
  find_package(X11 REQUIRED)

  target_link_libraries(LupineEngine PRIVATE
    Threads::Threads ${CMAKE_DL_LIBS} ${X11_LIBRARIES}
  )

  # Audio libraries
  find_library(ASOUND_LIBRARY asound)
  if(ASOUND_LIBRARY)
    target_link_libraries(LupineEngine PRIVATE ${ASOUND_LIBRARY})
  endif()
endif()

#--- Platform-specific Compile Definitions ---
target_compile_definitions(LupineEngine PRIVATE
  LUPINE_EMBED_WINDOWS_LIBRARIES
  LUPINE_EMBED_LINUX_LIBRARIES
  LUPINE_EMBED_MACOS_LIBRARIES
  LUPINE_EMBED_ARM64_LIBRARIES
)

# Add platform-specific definitions
if(WIN32)
  target_compile_definitions(LupineEngine PRIVATE
    WIN32_LEAN_AND_MEAN
    NOMINMAX
    UNICODE
    _UNICODE
    # OpenGL extensions
    GL_GLEXT_PROTOTYPES
  )
  # For static Qt builds
  if(QT_STATIC_DIR)
    target_compile_definitions(LupineEngine PRIVATE QT_STATIC_BUILD)
  endif()
endif()

#--- Runtime Executable ---
add_executable(lupine-runtime "src/runtime/main.cpp")
if(WIN32)
  target_sources(lupine-runtime PRIVATE "src/runtime/resources/lupine-runtime.rc")
endif()

target_link_libraries(lupine-runtime PRIVATE LupineEngine)
set_target_properties(lupine-runtime PROPERTIES RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin")

#--- Qt Editor Executable ---
if(LUPINE_ENABLE_EDITOR AND Qt6_FOUND)
  message(STATUS "=== Building Qt Editor ===")

  # Enable Qt automation
  set(CMAKE_AUTOMOC ON)
  set(CMAKE_AUTOUIC ON)
  set(CMAKE_AUTORCC ON)

  # Collect editor sources
  file(GLOB_RECURSE EDITOR_SOURCES "src/editor/*.cpp")
  file(GLOB_RECURSE EDITOR_HEADERS "src/editor/*.h" "include/lupine/editor/*.h")

  # Editor resources
  set(EDITOR_RESOURCES)
  if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/editor/resources/editor.qrc")
    list(APPEND EDITOR_RESOURCES "src/editor/resources/editor.qrc")
  endif()

  if(WIN32 AND EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/editor/resources/lupine-editor.rc")
    list(APPEND EDITOR_RESOURCES "src/editor/resources/lupine-editor.rc")
  endif()

  # Create editor executable
  add_executable(lupine-editor ${EDITOR_SOURCES} ${EDITOR_HEADERS} ${EDITOR_RESOURCES})

  # Link libraries
  target_link_libraries(lupine-editor PRIVATE
    LupineEngine
    Qt6::Core Qt6::Widgets Qt6::Gui Qt6::OpenGL Qt6::OpenGLWidgets
  )

  # Platform-specific editor linking using robust Qt configuration
  if(WIN32)
    # Use the robust Qt static linking configuration
    configure_qt6_static_linking(lupine-editor)
  endif()

  # Set editor properties
  set_target_properties(lupine-editor PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
    WIN32_EXECUTABLE TRUE
    MACOSX_BUNDLE TRUE
  )

  message(STATUS "Editor executable configured")
else()
  message(STATUS "Editor build disabled or Qt not found")
endif()

#--- Web Export Template ---
if(BUILD_WEB_TEMPLATE)
  add_executable(lupine-web-template
    "src/export/web/WebRuntimeMain.cpp"
    "src/export/web/WebScriptBridge.cpp"
    ${ENGINE_SOURCES}
  )
  target_compile_definitions(lupine-web-template PRIVATE LUPINE_WEB_BUILD=1 LUPINE_PLATFORM_WEB=1)
  set_target_properties(lupine-web-template PROPERTIES
    LINK_FLAGS "-s USE_SDL=2 -s USE_SDL_IMAGE=2 -s USE_SDL_TTF=2 -s WASM=1 -s ALLOW_MEMORY_GROWTH=1"
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/web"
  )
endif()

#--- Cross-Compilation Setup ---
if(LUPINE_ENABLE_CROSS_COMPILATION)
  message(STATUS "=== Cross-Compilation Configuration ===")

  # Define all target platforms
  set(CROSS_COMPILE_PLATFORMS "Windows;Linux;Mac-OSX;Mac-ARM64")

  # Check which platforms have libraries available
  set(AVAILABLE_PLATFORMS)
  foreach(platform IN LISTS CROSS_COMPILE_PLATFORMS)
    set(platform_lib_dir "${THIRDPARTY_DIR}/${platform}/lib")
    if(EXISTS "${platform_lib_dir}")
      list(APPEND AVAILABLE_PLATFORMS ${platform})
      message(STATUS "✅ ${platform} libraries available")
    else()
      message(STATUS "❌ ${platform} libraries missing")
    endif()
  endforeach()

  if(AVAILABLE_PLATFORMS)
    message(STATUS "Cross-compilation enabled for: ${AVAILABLE_PLATFORMS}")

    # Add compile definitions for available platforms
    target_compile_definitions(LupineEngine PRIVATE
      LUPINE_ENABLE_CROSS_COMPILATION
    )

    foreach(platform IN LISTS AVAILABLE_PLATFORMS)
      string(TOUPPER ${platform} platform_upper)
      string(REPLACE "-" "_" platform_define ${platform_upper})
      target_compile_definitions(LupineEngine PRIVATE
        "LUPINE_EMBED_${platform_define}_LIBRARIES"
      )
    endforeach()

    # Create cross-compilation info header
    set(CROSS_COMPILE_HEADER "${CMAKE_BINARY_DIR}/include/lupine/cross_compile_info.h")
    file(WRITE ${CROSS_COMPILE_HEADER}
      "// Auto-generated cross-compilation information\n"
      "#pragma once\n\n"
      "#define LUPINE_CROSS_COMPILE_ENABLED 1\n"
    )

    foreach(platform IN LISTS AVAILABLE_PLATFORMS)
      string(TOUPPER ${platform} platform_upper)
      string(REPLACE "-" "_" platform_define ${platform_upper})
      file(APPEND ${CROSS_COMPILE_HEADER}
        "#define LUPINE_HAS_${platform_define}_LIBS 1\n"
      )
    endforeach()

    # Add the generated include directory
    target_include_directories(LupineEngine PRIVATE "${CMAKE_BINARY_DIR}/include")

  else()
    message(WARNING "No cross-compilation libraries found. Run setup script to download them.")
  endif()
endif()

#--- Output Directories ---
set(ALL_TARGETS LupineEngine lupine-runtime)

if(LUPINE_ENABLE_EDITOR AND Qt6_FOUND)
  list(APPEND ALL_TARGETS lupine-editor)
endif()

if(BUILD_WEB_TEMPLATE)
  list(APPEND ALL_TARGETS lupine-web-template)
endif()

# Set output directories for all targets
foreach(target IN LISTS ALL_TARGETS)
  if(TARGET ${target})
    set_target_properties(${target} PROPERTIES
      ARCHIVE_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/lib"
      LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/lib"
      RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
    )
  endif()
endforeach()

#--- Build Summary ---
message(STATUS "=== Build Summary ===")
message(STATUS "Targets to build:")
foreach(target IN LISTS ALL_TARGETS)
  if(TARGET ${target})
    message(STATUS "  ✓ ${target}")
  else()
    message(STATUS "  ✗ ${target} (disabled)")
  endif()
endforeach()

message(STATUS "Output directories:")
message(STATUS "  Executables: ${CMAKE_BINARY_DIR}/bin")
message(STATUS "  Libraries: ${CMAKE_BINARY_DIR}/lib")
message(STATUS "=== Configuration Complete ===")

# Create a custom target for easy building
add_custom_target(lupine-all
  DEPENDS ${ALL_TARGETS}
  COMMENT "Building all Lupine Engine targets"
)
